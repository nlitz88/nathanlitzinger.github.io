<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>My Chia Mine - Plotting With 10K SAS Drives | Nathan Litzinger</title><meta name=keywords content><meta name=description content="As my fourth semester was just wrapping up, I was getting ready to take a few much needed weeks off before work and unwind just a little bit. Two days after my last final, however, I found out about Chia. Needless to say, I guess I never got to stop!
Fortunately for me and many other homelab and mining enthusiasts, farming Chia is a lot of fun. And by fun, I mean spending ludacris amounts of money on enterprise hardware that we would otherwise never have an excuse to buy."><meta name=author content="Nathan Litzinger"><link rel=canonical href=https://nlitz88.github.io/posts/chia10kplotting/chia_1/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.6cba0d81b5f3f42bb578d49f402ba4175aa72b43def148780b8ad714c957c6f5.css integrity="sha256-bLoNgbXz9Cu1eNSfQCukF1qnK0Pe8Uh4C4rXFMlXxvU=" rel="preload stylesheet" as=style><link rel=preload href=https://github.com/nlitz88.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://nlitz88.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://nlitz88.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://nlitz88.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://nlitz88.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://nlitz88.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="My Chia Mine - Plotting With 10K SAS Drives"><meta property="og:description" content="As my fourth semester was just wrapping up, I was getting ready to take a few much needed weeks off before work and unwind just a little bit. Two days after my last final, however, I found out about Chia. Needless to say, I guess I never got to stop!
Fortunately for me and many other homelab and mining enthusiasts, farming Chia is a lot of fun. And by fun, I mean spending ludacris amounts of money on enterprise hardware that we would otherwise never have an excuse to buy."><meta property="og:type" content="article"><meta property="og:url" content="https://nlitz88.github.io/posts/chia10kplotting/chia_1/"><meta property="og:image" content="https://nlitz88.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-30T20:58:21-04:00"><meta property="article:modified_time" content="2021-05-30T20:58:21-04:00"><meta property="og:site_name" content="Nathan Litzinger"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nlitz88.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="My Chia Mine - Plotting With 10K SAS Drives"><meta name=twitter:description content="As my fourth semester was just wrapping up, I was getting ready to take a few much needed weeks off before work and unwind just a little bit. Two days after my last final, however, I found out about Chia. Needless to say, I guess I never got to stop!
Fortunately for me and many other homelab and mining enthusiasts, farming Chia is a lot of fun. And by fun, I mean spending ludacris amounts of money on enterprise hardware that we would otherwise never have an excuse to buy."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://nlitz88.github.io/posts/"},{"@type":"ListItem","position":2,"name":"My Chia Mine - Plotting With 10K SAS Drives","item":"https://nlitz88.github.io/posts/chia10kplotting/chia_1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"My Chia Mine - Plotting With 10K SAS Drives","name":"My Chia Mine - Plotting With 10K SAS Drives","description":"As my fourth semester was just wrapping up, I was getting ready to take a few much needed weeks off before work and unwind just a little bit. Two days after my last final, however, I found out about Chia. Needless to say, I guess I never got to stop!\nFortunately for me and many other homelab and mining enthusiasts, farming Chia is a lot of fun. And by fun, I mean spending ludacris amounts of money on enterprise hardware that we would otherwise never have an excuse to buy.","keywords":[],"articleBody":"As my fourth semester was just wrapping up, I was getting ready to take a few much needed weeks off before work and unwind just a little bit. Two days after my last final, however, I found out about Chia. Needless to say, I guess I never got to stop!\nFortunately for me and many other homelab and mining enthusiasts, farming Chia is a lot of fun. And by fun, I mean spending ludacris amounts of money on enterprise hardware that we would otherwise never have an excuse to buy. It is for this reason I have enjoyed the past few weeks of running around. Sure, I didn’t exactly get to drop everything, and I didn’t exactly get a jump start on some of my other projects, but it has been a ton of fun embarking on this IT-fueled plotting and farming journey. Anyways, the focus of this post is about plotting. In particular, plotting on old SAS hard drives and what kind of yield you can expect.\nThe Hardware I’m doing my best to avoid storytelling here, so I’ll get straight to the details. Here’s the system I had on hand (cries in no more gaming):\n Ryzen 5 3600 24GB 3200MHz DDR4 Ram An old GT210 (not important)  The morning after finding out about Chia, I frantically bought 4x10TB external hard drives for $20/TB (still early enough), and also bought a single 1TB inland premium nvme m.2 ssd. However, after seeing SlothTech’s video, I eventually decided to go down the rabbit hole of plotting on hard drives. I landed on this model for a few reasons:\n This option was sustainable. Drives don’t have an absolute life. Sure, most of the drives I ordered arrived virtually on the brink of death, but a few bad-sector repairs later with e2fsck and I was off to the races. This option was economical. Even if my drives fail, there is a MASSIVE surplus of these on eBay. You can get a 300GB 10K SAS drive for ~$14, and 15K’s for not much more. Bottom line: it’s probably cheaper to replace these drives as the fail over time than to burn through brand new SSDs. This option was scalable. No, I’m not trying to get 80+ plots/day, but with this model, you could much more affordably. Buy a couple of 2.5\" disk shelves or server with 2.5\" hot swap bays, buy a few more HBA’s, and you’re in business.  The Plotting Drives Ultimately, I ended up ordering a lot of 10 300GB 10K SAS drives (HP). Most of these drives have 50+ thousand hours on them, and I’ve had two already crap out on me (they need some attention). BUT, sticking with the idea above, it would be cheaper to replace them as they die than to use that inland nvme I bought earlier. Starting off, I got away with spending only $6 per drive. Also, note that I chose 300GB drives as the temp size of a given plot won’t exceed 256GB (roughly around there), so 300GB will be the optimal size.\nHBA and Adapters To get these drives onto my machine, I ended up going with an LSI-9210-8i.\nThis gave me two SAS SFF-8087 ports, each of which I could expand to 4 SFF-8482 to connect the drives to. I used two of these second-hand Dell Adapters, as the popularized options were becoming very hard to find.\nI filled the 2nd and only remaining PCIEx16 slot of my mATX B450 motherboard with the 9210-8i, and connected up my drives. This is what the setup looks like today:\nI know, I know. It’s a little, well….cardboard. This was my in-a-pinch solution for organizing the drives. In an upcoming post, I’ll go over my newest solution, but for now, this is what we’ve to work with. Today, I just have the drives upright and a big desktop blowing over them to keep them nice and cool.\nBeyond these, I just have my farming drives connected via USB for now until I get my DS4246 setup, and that’s essentially it for the hardware department.\nThe Software While I was waiting for all the hardware to arrive, I began pourin through Chia discord servers and YouTube videos to begin my optimization research, if I can call it that (ha!). Anyways, the general report was that most people saw a 10% performance increase when plotting on a *nix OS vs Windows. Feeling like I needed to warm up my Linux skills once again, I saw this as an opportunity to learn some more and decided I’d set up my plotting machine on Ubuntu 20.04. Yeah, I could’ve done just Ubuntu-server, but I initially didn’t want to have to think about using Chia without the GUI (silly, I know. Got over that pretty quick).\nAs for the plotting itself, I decided to use Swar’s Plot Manager. A lot of people seem to like plotman as well, but I decided to go with the cross-platform option just for kicks. Plus it seems like there was a lot more support for Swar in the Discord servers I was in.\nNow for what we all actually care about!\nMy First Attempt At Plotting on Rust Soooo, my first attempt at this turned out to be more of an experiment than I realized. See, I bought these drives thinking that the only natural solution was to setup an mdadm RAID 0 and get some substantial write speed. And well, that was pretty true. I set the drives up in a RAID 0 with mdadm and created ran XFS on top of the array (I also tested with EXT4 on the array with basically the same results). Running a 10GB DD test, the array managed to write at 1.6GB/s. Not bad! However, this isn’t quite the case for plotting.\nWhile I don’t personally know enough about this to go into any substantial detail, what an Admin in SlothTech’s Discord explained was that with this many disks in a RAID0, plotting essentially caused more effectively random writes, rather than sequential. Again, that’s probably fairly poor phrasing, but nonetheless an inherent flaw of such a setup.\nThis didn’t discourage me from testing it first, however. To my own surprise, the array didn’t do half bad! Below are the plot times that I saw.\nFor those unaquainted, getting this kind of performance out of $10 drives is…pretty great. It was very encouraging to see these kinds of results early on. Despite what we knew about the inherent flaw of running a RAID0, my setup was doing something right.\nHOWEVER, it wasn’t quite that simple.\nMy Problems With 10K Drives in RAID 0 See, though I got a stable 16 plots out of this RAID setup, it wasn’t long before one of these decaying drives decided to start throwing sector errors. To be honest, I had no idea what was going on at first. I just knew that all of my plots were reporting that they\nOnly read 43984 of 262130 bytes at offset 593462320 from \"/mnt/md0/plot-k32-2021-05-25-22-18-7c60eb1983721f2d8c8ee35e5ded7a0098e5fa13aa05d8604c4d7af24f2e5b50.plot.p1.t5.sort_bucket_087.tmp\" with length 738436336. Error 1. Retrying in five minutes. Only read 43984 of 262130 bytes at offset 593462320 from \"/mnt/md0/plot-k32-2021-05-25-22-18-7c60eb1983721f2d8c8ee35e5ded7a0098e5fa13aa05d8604c4d7af24f2e5b50.plot.p1.t5.sort_bucket_087.tmp\" with length 738436336. Error 1. Retrying in five minutes. Scratching my head, I did some searching, and most people getting the same error were told that it was because they ran out of space. Well, that wasn’t quite the problem for me, I had plenty of room left. Reading further, others said that an “ERROR 1” (what this was) was due to a problem with the temporary disk. It was at this point that I did some digging and eventually noticed in the syslog this error showing up around the same time my plots failed:\ncritical medium error, dev sdc, sector 312500636 op 0x0:(READ) flags 0x80000 phys_seg 77 prio class 0 Critical medium error??? Well, I eventually figured out that this was due to bad sectors on the disk. I figured there had to be some way to tell the host to just exclude/ignore said bad sectors, and as it turns out, there was! I followed this guide to help sort things out, and it seemed fix things up.\nWell, sort of. It’s not that e2fsck didn’t work (to my knowledge), but rather anytime ANY disk had an issue, all of my concurrent plots basically tanked. Breakup the array, unmount the broken disk, fix the partition, rinse and repeat. Again, I’m a noobie, so I’m sure I could’ve been missing some life-changing detail along the way, but this kept happening. I kept losing plots, and I couldn’t finish any benchmarks I was doing. I wasn’t so much getting discouraged as much as I was fed up with faulty disks and how bad they were behaving in this array.\nAgain, I could definitely be to blame here. But I really think whatever was going on was just too much to deal with when all of the drives I would be buying could be just as faulty. If a disk fails? No problem! But I don’t want to lose all my plots. This is ultimately what turned me off of this configuration of the 10K disks. Additionally, though, despite plot times being faster, I wasn’t able to run as many in parallel as a I was when plotting individually, and I ended up getting better, more consistent performance individually after testing.\nPlotting Individually Ah yes, here at last. I didn’t realize this is what Alex from Sloth Tech was doing when he first made his video (I must’ve glossed straight over those details). Regardless, this is what has ultimately performed most optimally for me and my setup. The logic is as follows:\n Despite having slower temporary drives, you can basically (not always) have as many concurrent plots as you have drives, just so long as you have the threads and Memory to back the jobs up. Soooooo, higher core count Xeon CPUS, some old ECC DDR3 ram, and a whole bunch of SAS HDD’s is the perfect recipe for lots of plots in parallel! Because the disks are the bottleneck, the only way you’ll max out your CPU and Memory is by adding more drives and subsequent plots! Though plots will take a lot longer to complete, you can complete a whole lot more concurrently than lower capacity or lower drive count setups like you might see with higher speed temporary storage solutions (like NVME drives or even my RAID 0 setup). And, if you lose a disk, then only one plot is affected!  All of these points in mind, I used fdisk to create new partitions on each drive, setup EXT4 on each drive’s partition, and then mounted each drive to /mnt/plot1, /mntplot2, etc, etc (and eventually remembered to add these mounts to fstab).\nNow, I had to figure out how to get this setup in SWAR.\nDon’t Do This Now initially I didn’t set this up correctly. I tried to use only a SINGLE job in Swar’s config and listed the eight mountpoints under the temporary directory. The trouble with this that if plots start finishing in odd orders, or if you lose a disk, or any number of things don’t go EXACTLY how they’re supposed to, SWAR will try to start another plot on a drive that is already being plotted with. This fails because\n That drive is going to run out of space in no time (My drives are only 279.8GB) The write speed to that drive is going to drop to a screeching halt. Not literally, but it’ll take twice as long (if not more) to plot two on the same drive. Bad idea, easily avoided, don’t do it.  Probably The Best Route If you’re plotting with 10K/15K drives, unless you’ve found success with multiple RAID0’s between two disks and so forth, this is probably the approach you’ll want to take.\nBasically, I created a job for each drive. That is, for those still learning, you’ll want to add a new configuration to the config under jobs for each SAS drive you’re using for plotting. Each job you set up should allow no more than 1 concurrent plot at a time. This way, only a single plot will be created on the disk of that job, rather than multiple. I also set the max for phase 1 to 1, but that technically shouldn’t be necessary.\nNow, in order to avoid a bottleneck in the copy phase (phase 5), I had to consider the amount of time that would need to pass between the various jobs. Because stagger time only dicates the amonut of time a job must wait between it’s own plots, it is useless in this case. Instead, I stagger the jobs by setting their initial_delay_minutes. If I want the plots of the different jobs to be staggered by 60 minutes, then I set the initial delay of each job to a multiple of 60, beginning with 0. This ultimately staggers the plots of the different jobs like so:\nThis is important so that the Copy Phase (phase 5) doesn’t bottleneck your entire pipeline. Though the max time I recorded for the copy phase was about 12 minutes, I can’t set my stagger to 12 minutes. In a perfect world, sure. In reality, however, plots don’t always take the same amount of time. 60 minutes of cushion was what I could afford and it has yielded the smoothest results. If you’re running more concurrently, you might eventually end up bumping this down I’d imagine, but again, that’s all for testing.\nAlso, I made a claim earlier that you can basically run as many concurrent plotting jobs as you have drives, and I think this will be true for 90% of people. At least in my experience, because the disk is your bottleneck, even if you don’t technically have enough threads (2 per plot), I’ve found that it hasn’t made a difference in my experience (with my 6 core 12 thread Ryzen). Additionally, for those same reasons, I have only been running my plots with 2300MB of memory. Again, no issues. This could be another baseless claim, but this is what has worked in my setup. So, in my case, I was able to set a global max_concurrent of 8 and a max_for_phase_1 of 8 without issue.\nWith all of this said, my system was able to do 18 plots today, and I’m thinking it might be able to do 19 tomorrow. I still have some playing around to do, but so far this is what I’ve gotten to:\nI definitely may have brushed over some details here, so I’m attaching my current config.yaml for anyone curious. If you’re getting started or want to see what’s up with this setup, hopefully that will get you the answers you’re looking for.\nConfig.yaml\nObservations While I don’t have a whole book for this section, myself and a few others from Sloth Tech’s Discord Server (which at this point, I should have linked. Here it is) couldn’t help but notice that some of my plot times were a fair bit less than those with similar machines. What differed mainly between our machines was the CPU and memory technology. I’m not a memory expert, so I can’t really say how much of an impact DDR4 ram had vs their DDR3, but I was more inclined to think that the single core performance of our CPU’s was what ultimately was accontable for that difference. With the same disks, it seemed to be the only obvious variable that had really changed, so perhaps more testing will be done to see how big of a difference it really is. In truth, our tests weren’t more than maybe 45 minutes off, so I doubt it’s that big a of deal. It does mean that there is perhaps slightly more at play than just the bottleneck of the slow disks.\nFuture Improvements/Tests These are just some notable tests that myself or other users from the Discord have been talking about doing with SAS hard drives.\nSata SSD Temporary2 Device While I haven’t personally implemented this, a certain PaulB from the Discord found that using a 512GB (or so) Sata SSD as a temporary2 device in combination with his 10K drives helped to shave off almost two hours worth of plot time! Now, whether the improvements are this aggressive in every case, I don’t know yet. It is however a promising improvement that I may look into implementing myself.\nOne possible red flag is: “SSD? I thought we wanted to avoid burning through those!” Absolutely. However, the Temp2 directory doesn’t experience the same volume of writes that the main temporary directories do. Rather, I believe only the size of the plot (or maybe less) gets written to the temp2 device per plot. I need to check my facts on that point, but nonetheless, lower endurance, lower speed SSD’s are more than equipped to handle this simple improvement.\nExtra Memory? Decrease Bucket Size Another user was discussing how, by decreasing the bucket size, you’re effectively decreasing the number of lookups that need to be performed on the slower 10K hard disk. The cost, however, is that a plot will need just about twice as much ram then. If you have some extra overhead, though, this could be a very good way to speed things up. This is a pretty useless claim without any quantitative data yet, but I’ll be keeping my eye out for those testing and see what happens.\nMy (2nd) Dell Poweredge T420 I caved. The setup you see pictured above is what I am starting with. However, I had to come to terms with reality: I’m still a student, I’ll be working shortly, and I just won’t have as much time to babysit or put up with the nuances of my cardboard-based solution. Not that it’s toppling over every ten minutes or anything, but it’s just kind of a pain.\n I run a loud fan to keep the drives cool I basically lost my second desk to that whole setup I don’t have another UPS for my current plotter all the way over there.  Not to mention, I have an entire 40U of server rack sitting next to me. With my brother also conveniently looking to ugprade his gaming PC to something more like what I’m plotting on, I agreed to sell it to him. With this money, another Dell Poweredge T420 will end up in my rack.\nDespite albeit less single core performance from the E5-2450 V2’s I’m putting in it, this T420 has room for 16 2.5\" drives, so I can just scale up and not notice it anyways. More importantly, though, this solution just makes more sense for me. I can easily connect my disk shelf to it, all of the plotting drives are easily accessible and uniformly maintained, and everything is battery backed up and contained neatly in my rack. It’s scalable, economical, and makes the most sense for me. I do have a few qualms with the T420, but in this instance, I think it’ll be just what I’ve been looking for. Updates to come…\n","wordCount":"3185","inLanguage":"en","datePublished":"2021-05-30T20:58:21-04:00","dateModified":"2021-05-30T20:58:21-04:00","author":{"@type":"Person","name":"Nathan Litzinger"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nlitz88.github.io/posts/chia10kplotting/chia_1/"},"publisher":{"@type":"Organization","name":"Nathan Litzinger","logo":{"@type":"ImageObject","url":"https://nlitz88.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://nlitz88.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://nlitz88.github.io/resume/ title=Resume><span>Resume</span></a></li><li><a href=https://nlitz88.github.io/projects title=Projects><span>Projects</span></a></li><li><a href=https://nlitz88.github.io/posts title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://nlitz88.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://nlitz88.github.io/posts/>Posts</a></div><h1 class=post-title>My Chia Mine - Plotting With 10K SAS Drives</h1><div class=post-meta>May 30, 2021&nbsp;·&nbsp;15 min&nbsp;·&nbsp;Nathan Litzinger&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/chia10kplotting/chia_1.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p><img loading=lazy src=/posts/chia10kplotting/plottingMachine1.JPG alt="My Plotting Machine"></p><p>As my fourth semester was just wrapping up, I was getting ready to take a few much needed weeks off before work and unwind just a little bit. Two days after my last final, however, I found out about Chia. Needless to say, I guess I never got to stop!</p><p>Fortunately for me and many other homelab and mining enthusiasts, <em>farming</em> Chia is a lot of fun. And by fun, I mean spending ludacris amounts of money on enterprise hardware that we would otherwise never have an excuse to buy. It is for this reason I have enjoyed the past few weeks of running around. Sure, I didn&rsquo;t exactly get to drop everything, and I didn&rsquo;t exactly get a jump start on some of my other projects, but it has been a ton of fun embarking on this IT-fueled plotting and farming journey. <strong>Anyways</strong>, the focus of this post is about plotting. In particular, plotting on old SAS hard drives and what kind of yield you can expect.</p><h1 id=the-hardware>The Hardware<a hidden class=anchor aria-hidden=true href=#the-hardware>#</a></h1><p>I&rsquo;m doing my best to avoid storytelling here, so I&rsquo;ll get straight to the details. Here&rsquo;s the system I had on hand (<em>cries in no more gaming</em>):</p><ul><li>Ryzen 5 3600</li><li>24GB 3200MHz DDR4 Ram</li><li>An old GT210 (not important)</li></ul><p>The morning after finding out about Chia, I frantically bought <strong>4x10TB external hard drives</strong> for $20/TB (still early enough), and also bought a single <strong>1TB</strong> inland premium nvme m.2 ssd. However, after seeing <a href="https://www.youtube.com/watch?v=QHnTC07yGEA">SlothTech&rsquo;s video</a>, I eventually decided to go down the rabbit hole of plotting on hard drives. I landed on this model for a few reasons:</p><ol><li>This option was sustainable. Drives don&rsquo;t have an <em>absolute</em> life. Sure, most of the drives I ordered arrived virtually on the brink of death, but a few bad-sector repairs later with <strong>e2fsck</strong> and I was off to the races.</li><li>This option was economical. <strong>Even if</strong> my drives fail, there is a MASSIVE surplus of these on eBay. You can get a 300GB 10K SAS drive for ~$14, and 15K&rsquo;s for not much more. Bottom line: it&rsquo;s probably cheaper to replace these drives as the fail over time than to burn through brand new SSDs.</li><li>This option was scalable. No, I&rsquo;m not trying to get 80+ plots/day, but with this model, <em>you could much more affordably</em>. Buy a couple of 2.5" disk shelves or server with 2.5" hot swap bays, buy a few more HBA&rsquo;s, and you&rsquo;re in business.</li></ol><h3 id=the-plotting-drives>The Plotting Drives<a hidden class=anchor aria-hidden=true href=#the-plotting-drives>#</a></h3><p>Ultimately, I ended up ordering a lot of 10 <strong>300GB 10K SAS drives</strong> (HP). Most of these drives have 50+ thousand hours on them, and I&rsquo;ve had two already crap out on me (they need some attention). BUT, sticking with the idea above, it would be cheaper to replace them as they die than to use that inland nvme I bought earlier. Starting off, I got away with spending only $6 per drive. Also, note that I chose 300GB drives as the temp size of a given plot won&rsquo;t exceed 256GB (roughly around there), so 300GB will be the optimal size.</p><p><img loading=lazy src=/posts/chia10kplotting/10KDrives1.png alt="My first lot of drives"></p><h3 id=hba-and-adapters>HBA and Adapters<a hidden class=anchor aria-hidden=true href=#hba-and-adapters>#</a></h3><p>To get these drives onto my machine, I ended up going with an LSI-9210-8i.</p><p><img loading=lazy src=/posts/chia10kplotting/hba.png alt=HBA>
This gave me two SAS SFF-8087 ports, each of which I could expand to 4 SFF-8482 to connect the drives to. I used two of these second-hand Dell Adapters, as the popularized options were becoming very hard to find.</p><p><img loading=lazy src=/posts/chia10kplotting/adapters.png alt=SFF-8087&amp;ndash;&amp;gt;SFF-8482></p><p>I filled the 2nd and only remaining PCIEx16 slot of my mATX B450 motherboard with the 9210-8i, and connected up my drives. This is what the setup looks like today:</p><p><img loading=lazy src=/posts/chia10kplotting/cardboard.JPG alt="It&amp;rsquo;s ghetto, I know"></p><p>I know, I know. It&rsquo;s a little, well&mldr;.cardboard. This was my in-a-pinch solution for organizing the drives. In an upcoming post, I&rsquo;ll go over my newest solution, but for now, this is what we&rsquo;ve to work with. Today, I just have the drives upright and a big desktop blowing over them to keep them nice and cool.</p><p>Beyond these, I just have my farming drives connected via USB for now until I get my DS4246 setup, and that&rsquo;s essentially it for the hardware department.</p><h1 id=the-software>The Software<a hidden class=anchor aria-hidden=true href=#the-software>#</a></h1><p>While I was waiting for all the hardware to arrive, I began pourin through Chia discord servers and YouTube videos to begin my <em>optimization research</em>, if I can call it that (ha!). Anyways, the general report was that most people saw a 10% performance increase when plotting on a *nix OS vs Windows. Feeling like I needed to warm up my Linux skills once again, I saw this as an opportunity to learn some more and decided I&rsquo;d set up my plotting machine on Ubuntu 20.04. Yeah, I could&rsquo;ve done just Ubuntu-server, but I initially didn&rsquo;t want to have to think about using Chia without the GUI (silly, I know. Got over that pretty quick).</p><p>As for the plotting itself, I decided to use <a href=https://github.com/swar/Swar-Chia-Plot-Manager>Swar&rsquo;s Plot Manager</a>. A lot of people seem to like plotman as well, but I decided to go with the cross-platform option just for kicks. Plus it seems like there was a lot more support for Swar in the Discord servers I was in.</p><p>Now for what we all actually care about!</p><h1 id=my-first-attempt-at-plotting-on-rust>My First Attempt At Plotting on Rust<a hidden class=anchor aria-hidden=true href=#my-first-attempt-at-plotting-on-rust>#</a></h1><p>Soooo, my first attempt at this turned out to be more of an experiment than I realized. See, I bought these drives thinking that the only natural solution was to setup an mdadm RAID 0 and get some substantial write speed. And well, that was pretty true. I set the drives up in a RAID 0 with mdadm and created ran XFS on top of the array (I also tested with EXT4 on the array with basically the same results). Running a 10GB DD test, the array managed to write at 1.6GB/s. Not bad! However, this isn&rsquo;t quite the case for plotting.</p><p>While I don&rsquo;t personally know enough about this to go into any substantial detail, what an Admin in SlothTech&rsquo;s Discord explained was that with this many disks in a RAID0, plotting essentially caused more <em>effectively random</em> writes, rather than sequential. Again, that&rsquo;s probably fairly poor phrasing, but nonetheless an inherent flaw of such a setup.</p><p>This didn&rsquo;t discourage me from testing it first, however. To my own surprise, the array didn&rsquo;t do half bad! Below are the plot times that I saw.</p><p><img loading=lazy src=/posts/chia10kplotting/raidTimes.png alt="Raid0 Array Plotting Performance"></p><p>For those unaquainted, getting this kind of performance out of $10 drives is&mldr;<strong>pretty great</strong>. It was very encouraging to see these kinds of results early on. Despite what we knew about the inherent flaw of running a RAID0, my setup was doing something right.</p><p><strong>HOWEVER</strong>, it wasn&rsquo;t quite that simple.</p><h3 id=my-problems-with-10k-drives-in-raid-0>My Problems With 10K Drives in RAID 0<a hidden class=anchor aria-hidden=true href=#my-problems-with-10k-drives-in-raid-0>#</a></h3><p>See, though I got a stable 16 plots out of this RAID setup, it wasn&rsquo;t long before one of these decaying drives decided to start throwing sector errors. To be honest, I had no idea what was going on at first. I just knew that all of my plots were reporting that they</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Only read <span style=color:#ae81ff>43984</span> of <span style=color:#ae81ff>262130</span> bytes at offset <span style=color:#ae81ff>593462320</span> from <span style=color:#e6db74>&#34;/mnt/md0/plot-k32-2021-05-25-22-18-7c60eb1983721f2d8c8ee35e5ded7a0098e5fa13aa05d8604c4d7af24f2e5b50.plot.p1.t5.sort_bucket_087.tmp&#34;</span> with length 738436336. Error 1. Retrying in five minutes.
Only read <span style=color:#ae81ff>43984</span> of <span style=color:#ae81ff>262130</span> bytes at offset <span style=color:#ae81ff>593462320</span> from <span style=color:#e6db74>&#34;/mnt/md0/plot-k32-2021-05-25-22-18-7c60eb1983721f2d8c8ee35e5ded7a0098e5fa13aa05d8604c4d7af24f2e5b50.plot.p1.t5.sort_bucket_087.tmp&#34;</span> with length 738436336. Error 1. Retrying in five minutes.
</code></pre></div><p>Scratching my head, I did some searching, and most people getting the same error were told that it was because they ran out of space. Well, that wasn&rsquo;t quite the problem for me, I had plenty of room left. Reading further, others said that an &ldquo;ERROR 1&rdquo; (what this was) was due to a problem with the temporary disk. It was at this point that I did some digging and eventually noticed in the <strong>syslog</strong> this error showing up around the same time my plots failed:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>critical medium error, dev sdc, sector <span style=color:#ae81ff>312500636</span> op 0x0:<span style=color:#f92672>(</span>READ<span style=color:#f92672>)</span> flags 0x80000 phys_seg <span style=color:#ae81ff>77</span> prio class <span style=color:#ae81ff>0</span>
</code></pre></div><p>Critical medium error??? Well, I eventually figured out that this was due to bad sectors on the disk. I figured there had to be some way to tell the host to just exclude/ignore said bad sectors, and as it turns out, there was! I followed <a href=https://www.linuxtechi.com/check-hard-drive-for-bad-sector-linux/>this</a> guide to help sort things out, and it seemed fix things up.</p><p>Well, sort of. It&rsquo;s not that e2fsck didn&rsquo;t work (to my knowledge), but rather anytime ANY disk had an issue, all of my concurrent plots basically tanked. Breakup the array, unmount the broken disk, fix the partition, rinse and repeat. Again, I&rsquo;m a noobie, so I&rsquo;m sure I could&rsquo;ve been missing some life-changing detail along the way, but this <strong>kept happening</strong>. I kept losing plots, and I couldn&rsquo;t finish any benchmarks I was doing. I wasn&rsquo;t so much getting discouraged as much as I was fed up with faulty disks and how bad they were behaving in this array.</p><p>Again, I could definitely be to blame here. But I really think whatever was going on was just too much to deal with when all of the drives I would be buying could be just as faulty. If a disk fails? No problem! But I don&rsquo;t want to lose all my plots. This is ultimately what turned me off of this configuration of the 10K disks. Additionally, though, despite plot times being faster, I wasn&rsquo;t able to run as many in parallel as a I was when plotting individually, and I ended up getting better, <strong>more consistent</strong> performance individually after testing.</p><h3 id=plotting-individually>Plotting Individually<a hidden class=anchor aria-hidden=true href=#plotting-individually>#</a></h3><p>Ah yes, here at last. I didn&rsquo;t realize this is what Alex from Sloth Tech was doing when he first made his video (I must&rsquo;ve glossed straight over those details). Regardless, this is what has ultimately performed most optimally for me and my setup. The logic is as follows:</p><ul><li>Despite having slower temporary drives, you can <em>basically</em> (not always) have as many concurrent plots as you have drives, just so long as you have the <strong>threads</strong> and <strong>Memory</strong> to back the jobs up. Soooooo, higher core count Xeon CPUS, some old ECC DDR3 ram, and a whole bunch of SAS HDD&rsquo;s is the perfect recipe for lots of plots in parallel! Because the disks are the bottleneck, the only way you&rsquo;ll max out your CPU and Memory is by adding more drives and subsequent plots!</li><li>Though plots will take a lot longer to complete, you can complete a whole lot more concurrently than lower capacity or lower drive count setups like you might see with higher speed temporary storage solutions (like NVME drives or even my RAID 0 setup).</li><li>And, if you lose a disk, then only one plot is affected!</li></ul><p>All of these points in mind, I used <strong>fdisk</strong> to create new partitions on each drive, setup EXT4 on each drive&rsquo;s partition, and then mounted each drive to /mnt/plot1, /mntplot2, etc, etc (and eventually remembered to add these mounts to fstab).</p><p>Now, I had to figure out how to get this setup in SWAR.</p><h4 id=dont-do-this>Don&rsquo;t Do This<a hidden class=anchor aria-hidden=true href=#dont-do-this>#</a></h4><p>Now initially I didn&rsquo;t set this up correctly. I tried to use only a <strong>SINGLE</strong> job in Swar&rsquo;s config and listed the eight mountpoints under the temporary directory. The trouble with this that if plots start finishing in odd orders, or if you lose a disk, or any number of things don&rsquo;t go EXACTLY how they&rsquo;re supposed to, SWAR will try to start another plot on a drive that is already being plotted with. This fails because</p><ol><li>That drive is going to run out of space in no time (My drives are only 279.8GB)</li><li>The write speed to that drive is going to drop to a screeching halt. Not literally, but it&rsquo;ll take twice as long (if not more) to plot two on the same drive. Bad idea, easily avoided, don&rsquo;t do it.</li></ol><h4 id=probably-the-best-route>Probably The Best Route<a hidden class=anchor aria-hidden=true href=#probably-the-best-route>#</a></h4><p>If you&rsquo;re plotting with 10K/15K drives, unless you&rsquo;ve found success with multiple RAID0&rsquo;s between two disks and so forth, this is probably the approach you&rsquo;ll want to take.</p><p>Basically, I created a job for each drive. That is, for those still learning, you&rsquo;ll want to add a new configuration to the config under jobs for each SAS drive you&rsquo;re using for plotting. Each job you set up should allow no more than <strong>1 concurrent plot</strong> at a time. This way, only a single plot will be created on the disk of that job, rather than multiple. I also set the max for phase 1 to <strong>1</strong>, but that technically shouldn&rsquo;t be necessary.</p><p>Now, in order to avoid a bottleneck in the <strong>copy phase (phase 5)</strong>, I had to consider the amount of time that would need to pass between the various jobs. Because stagger time only dicates the amonut of time a job must wait between it&rsquo;s own plots, it is useless in this case. Instead, I stagger the jobs by setting their <strong>initial_delay_minutes</strong>. If I want the plots of the different jobs to be staggered by <em>60</em> minutes, then I set the initial delay of each job to a multiple of 60, beginning with 0. This ultimately staggers the plots of the different jobs like so:</p><p><img loading=lazy src=/posts/chia10kplotting/staggeredPlots.png alt="staggered plots"></p><p>This is important so that the <strong>Copy Phase (phase 5)</strong> doesn&rsquo;t bottleneck your entire pipeline. Though the max time I recorded for the copy phase was about 12 minutes, I can&rsquo;t set my stagger to 12 minutes. In a perfect world, sure. In reality, however, plots don&rsquo;t always take the same amount of time. 60 minutes of cushion was what I could afford and it has yielded the smoothest results. If you&rsquo;re running more concurrently, you might eventually end up bumping this down I&rsquo;d imagine, but again, that&rsquo;s all for testing.</p><p>Also, I made a claim earlier that you can basically run as many concurrent plotting jobs as you have drives, and I think this will be true for 90% of people. At least in my experience, because the disk is your bottleneck, even if you don&rsquo;t technically have enough threads (2 per plot), I&rsquo;ve found that it hasn&rsquo;t made a difference in my experience (with my 6 core 12 thread Ryzen). Additionally, for those same reasons, I have only been running my plots with 2300MB of memory. Again, no issues. This could be another baseless claim, but this is what has worked in my setup. So, in my case, I was able to set a global max_concurrent of 8 and a max_for_phase_1 of 8 without issue.</p><p>With all of this said, my system was able to do 18 plots today, and I&rsquo;m thinking it might be able to do 19 tomorrow. I still have some playing around to do, but so far this is what I&rsquo;ve gotten to:</p><p><img loading=lazy src=/posts/chia10kplotting/swar.png alt="My Swar"></p><p>I definitely may have brushed over some details here, so I&rsquo;m attaching my current config.yaml for anyone curious. If you&rsquo;re getting started or want to see what&rsquo;s up with this setup, hopefully that will get you the answers you&rsquo;re looking for.</p><p><a href=/posts/chia10kplotting/config.yaml>Config.yaml</a></p><h1 id=observations>Observations<a hidden class=anchor aria-hidden=true href=#observations>#</a></h1><p>While I don&rsquo;t have a whole book for this section, myself and a few others from Sloth Tech&rsquo;s Discord Server (which at this point, I should have linked. <a href=https://discord.gg/H6sWuPVzRP>Here it is</a>) couldn&rsquo;t help but notice that some of my plot times were a fair bit less than those with similar machines. What differed mainly between our machines was the CPU and memory technology. I&rsquo;m not a memory expert, so I can&rsquo;t really say how much of an impact DDR4 ram had vs their DDR3, but I was more inclined to think that the <strong>single core performance</strong> of our CPU&rsquo;s was what ultimately was accontable for that difference. With the same disks, it seemed to be the only obvious variable that had really changed, so perhaps more testing will be done to see how big of a difference it really is. In truth, our tests weren&rsquo;t more than maybe 45 minutes off, so I doubt it&rsquo;s that big a of deal. It does mean that there is perhaps slightly more at play than just the bottleneck of the slow disks.</p><h1 id=future-improvementstests>Future Improvements/Tests<a hidden class=anchor aria-hidden=true href=#future-improvementstests>#</a></h1><p>These are just some notable tests that myself or other users from the Discord have been talking about doing with <strong>SAS hard drives.</strong></p><h3 id=sata-ssd-temporary2-device>Sata SSD Temporary2 Device<a hidden class=anchor aria-hidden=true href=#sata-ssd-temporary2-device>#</a></h3><p>While I haven&rsquo;t personally implemented this, a certain PaulB from the Discord found that using a 512GB (or so) Sata SSD as a temporary2 device in combination with his 10K drives helped to shave off almost two hours worth of plot time! Now, whether the improvements are this aggressive in every case, I don&rsquo;t know yet. It is however a promising improvement that I may look into implementing myself.</p><p>One possible red flag is: &ldquo;SSD? I thought we wanted to avoid burning through those!&rdquo; Absolutely. However, the Temp2 directory doesn&rsquo;t experience the same volume of writes that the main temporary directories do. Rather, I believe only the size of the plot (or maybe less) gets written to the temp2 device per plot. I need to check my facts on that point, but nonetheless, lower endurance, lower speed SSD&rsquo;s are more than equipped to handle this simple improvement.</p><h3 id=extra-memory-decrease-bucket-size>Extra Memory? Decrease Bucket Size<a hidden class=anchor aria-hidden=true href=#extra-memory-decrease-bucket-size>#</a></h3><p>Another user was discussing how, by decreasing the bucket size, you&rsquo;re effectively decreasing the number of lookups that need to be performed on the slower 10K hard disk. The cost, however, is that a plot will need just about twice as much ram then. If you have some extra overhead, though, this could be a very good way to speed things up. This is a pretty useless claim without any quantitative data yet, but I&rsquo;ll be keeping my eye out for those testing and see what happens.</p><h3 id=my-2nd-dell-poweredge-t420>My (2nd) Dell Poweredge T420<a hidden class=anchor aria-hidden=true href=#my-2nd-dell-poweredge-t420>#</a></h3><p><img loading=lazy src=/posts/chia10kplotting/T420.png alt=T420></p><p>I caved. The setup you see pictured above is what I am starting with. However, I had to come to terms with reality: I&rsquo;m still a student, I&rsquo;ll be working shortly, and I just won&rsquo;t have as much time to babysit or put up with the nuances of my cardboard-based solution. Not that it&rsquo;s toppling over every ten minutes or anything, but it&rsquo;s just kind of a pain.</p><ol><li>I run a loud fan to keep the drives cool</li><li>I basically lost my second desk to that whole setup</li><li>I don&rsquo;t have another UPS for my current plotter all the way over there.</li></ol><p>Not to mention, I have an entire 40U of server rack sitting next to me. With my brother also conveniently looking to ugprade his gaming PC to something more like what I&rsquo;m plotting on, I agreed to sell it to him. With this money, another Dell Poweredge T420 will end up in my rack.</p><p>Despite albeit less single core performance from the E5-2450 V2&rsquo;s I&rsquo;m putting in it, this T420 has room for 16 2.5" drives, so I can just scale up and not notice it anyways. More importantly, though, this solution just makes more sense for me. I can easily connect my disk shelf to it, all of the plotting drives are easily accessible and uniformly maintained, and everything is battery backed up and contained neatly in my rack. It&rsquo;s scalable, economical, and makes the most sense for me. I do have a few qualms with the T420, but in this instance, I think it&rsquo;ll be just what I&rsquo;ve been looking for. Updates to come&mldr;</p></div><footer class=post-footer><nav class=paginav><a class=next href=https://nlitz88.github.io/posts/blockchainproject/blockchainproject/><span class=title>Next Page »</span><br><span>Penn State New Kensington Research Expo - Blockchain Technology</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://nlitz88.github.io/>Nathan Litzinger</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>